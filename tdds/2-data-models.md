# 数据模型

`TDD-2`

---

## 前置文档 {#prerequisite}

- [`TDD-1` 地图逻辑结构][tdd-1]

[tdd-1]: ./1-map-logic-structures.md

## 术语解释 {#terms}

以下为此文档会使用到的术语，在后续描述中，不再另行说明。

- `物品计数`：
  - 物品计数为当前点位在被统计为该物品时，所计算的点位数。此数字与点位采集所能获得的物品数量等无关。
  - 【物品计数】与【物品数量】也为不同的概念。物品数量表示为：物品关联中，物品条目的条数。

## 数据模型 {#data-models}

本章节介绍地区、物品分类、物品、点位的模型。此章节中，非重要字段将被省略。

### 地区模型 {#area-model}

``` typescript
interface AreaVo {
  id: number;           // 地区ID

  // 基础信息
  name: string;         // 地区名称
  code: string;         // 地区代码

  // 关联信息
  parentId: number;     // 父地区ID
  isFinal: boolean;     // 是否为叶子地区

  // 功能性字段
  hiddenFlag: number;   // 权限标记
  sortIndex: number;    // 排序序号
  iconId: number;       // 图标ID
}
```

- `父地区ID`：
  - 如果当前地区为一级地区，则父地区ID为 `-1`，表示该地区父地区为根地区；如果不为一级地区，父地区ID为其上一级的地区ID。
  - 由于当前地图只有两级区域，所以二级区域的父ID为对应的一级区域。
- `地区名称`：在应用里实际显示的地区名称。
- `地区代码`：地区对应的代码，用于确定对应的地区条目。
- `权限标记`：参见 [权限标记][tdd-2-hidden_flag]。
- `排序序号`：用于地区的排序，排序序号越小，数据在列表中越靠后。此排序序号仅在同父级时有意义。
- `图标ID`：参见 [`TDD-7` 图标数据][tdd-7]。

[tdd-2-hidden_flag]: #hidden-flag
[tdd-7]: ./7-icon-data.md

#### Q & A {#area-model-qa}

- 为什么需要使用地区代码而非地区名称或地区ID确定地区条目？
  - 在软件部署上线后，地区名称有可能会进行调整，使用地区名称会在名称改变时造成定位困难。
  - 本地图数据会部署到不同的环境，不同环境的地区ID可能会有差异。在某些场景下，需要将一些数据绑定到对应的地区，而ID在不同环境中不一致，会导致基于地区ID的绑定，在不同环境中无法直接迁移，从而增加维护成本。

### 物品分类模型 {#item-type-model}

``` typescript
interface ItemTypeVo {
  id: number;           // 物品分类ID

  // 基础信息
  name: string;         // 物品分类名称

  // 关联信息
  parentId: number;     // 父物品分类ID
  isFinal: boolean;     // 是否为叶子分类

  // 功能性字段
  sortIndex: number;    // 排序序号
  iconId: number;       // 图标ID
}
```

- `父物品分类ID`：
  - 如果当前分类为顶层分类，则父物品分类ID为 `-1`。
- `排序序号`：用于物品分类的排序，排序序号越小，数据在列表中越靠后。此排序序号仅在同父级时有意义。
- `图标ID`：参见 [`TDD-7` 图标数据][tdd-7]。

[tdd-7]: ./7-icon-data.md

### 物品模型 {#item-model}

``` typescript
interface ItemVo {
  id: number;           // 物品ID

  // 基础信息
  name: string;         // 物品名称

  // 模板数据
  defaultRefreshTime: number;   // 点位默认刷新时间
  defaultContent: string;       // 点位默认描述
  defaultCount: number;         // 物品关联默认计数

  // 关联信息
  areaId: number;       // 地区ID
  typeIdList: number[]; // 物品分类ID列表

  // 功能性字段
  specialFlag: number;      // 特殊物品标记
  hiddenFlag: number;       // 权限标记
  sortIndex: number;        // 排序序号
  iconStyleType: number;    // 图标样式
  iconId: number;           // 图标ID
  countSplit: Record<string, number>;
                            // 物品计数拆分
}
```

- `点位默认刷新时间`：新增与当前物品关联的点位时，默认填入的刷新时间。
- `点位默认描述`：新增与当前物品关联的点位时，默认填入的点位描述。
- `物品关联默认计数`：新增当前物品关联的点位，或对点位添加物品时，默认填入的物品关联计数。
- `地区ID`：物品绑定的地区ID。从业务需求而言，需要确保绑定的地区是叶子地区。
- `物品特殊标记`：参见 [`TDD-3` 特殊点位][tdd-3]。
- `权限标记`：参见 [权限标记][tdd-2-hidden_flag]。
- `排序序号`：用于物品的排序，排序序号越小，数据在列表中越靠后。此排序序号在同地区时有意义，若不同地区物品混合排序，此字段的值具有一定的参考意义。
- `图标样式`：不同的图标样式值，决定了此物品中点位图标显示时的不同行为：
  | 值 | 名称 | 图标 | 图标边框 | 坐标锚点 | 点位完成状态 |
  | --- | :--- | :--- | :--- | :--- | :--- |
  | `0` | 默认 | 基础图标 | 有边框 | 图钉锚点 | 有对勾 |
  | `1` | 无边框 | 基础图标 | 无边框 | 中心锚点 | 有对勾 |
  | `3` | 类神瞳 | 特殊图标 | 无边框 | 中心锚点 | 无对勾 |
  - 【基础图标】与【特殊图标】参见 [`TDD-7` 图标数据][tdd-7]。
- `图标ID`：此物品下的点位图标，均按照此图标ID对应的图标进行显示。参见 [`TDD-7` 图标数据][tdd-7]。
- `物品计数拆分`：该物品下所有点位对此物品的总计数，用于计数汇总统计。数据键为权限标记的值，值为物品计数总和。详见 [权限标记][tdd-2-hidden_flag] 章节。

[tdd-2-hidden_flag]: #hidden-flag
[tdd-3]: ./3-special-markers.md
[tdd-7]: ./7-icon-data.md

#### Q & A {#item-model-qa}

- 为什么需要点位默认刷新时间、点位默认描述、物品关联默认计数三个字段？
  - 这三个字段作为创建点位或点位中物品关联的模板数据，用于简化数据数据维护的步骤，以达到降低数据维护难度的效果。
- 为什么需要设计物品物品计数拆分，而不是使用单独的物品计数总和？
  - 根据本文档中 [权限标记][tdd-2-hidden_flag] 所述，物品→点位存在权限标记的继承和覆盖策略。在不同的可见性状态下，可见的数据部分不同，对应的物品计数总和也会产生差异。因此，需要将不同权限标记的计数汇总拆分开，由地图逻辑部分根据当前可见数据进行手动累加。

[tdd-2-hidden_flag]: #hidden-flag

### 点位模型 {#marker-model}

``` typescript
interface MarkerItemLinkVo {
  itemId: number;   // 物品ID
  count: number;    // 物品计数
}

interface MarkerVo {
  id: number;           // 点位ID

  // 基础信息
  markerTitle: string;  // 点位标题
  content: string;      // 点位内容

  // 补充信息
  picture: string;      // 图片地址
  videoPath: string;    // 视频路径

  // 位置信息
  position: string;     // 点位坐标

  // 关联数据
  itemList: MarkerItemLinkVo[]; // 关联物品

  // 功能性字段
  hiddenFlag: number;   // 权限标记
  refreshTime: number;  // 点位刷新时间
  extra: MarkerExtraVo; // 点位附加数据
  linkageId: string;    // 点位关联组ID
}
```

- `点位ID`：点位在全局唯一的序号。
- `图片地址`：点位图片的 URL 地址。
- `视频地址`：点位图片的视频地址，目前支持视频站点为：
  - [哔哩哔哩][bilibili]。
- `点位坐标`：格式为 `X,Y` 的坐标字符串。
- `关联物品`：点位所归属的物品及物品对应的物品计数。
- `点位刷新时间`：每个点位均存在刷新时间，刷新时间存在以下情况：
  - 正数：刷新的毫秒数。
  - `0`：不刷新。
  - 负数：根据不同的负数，表示不同的刷新逻辑。
- `权限标记`：参见 [权限标记][tdd-2-hidden_flag]。
- `点位附加数据`：点位附加数据，用于实现 [`TDD-3` 特殊点位][tdd-3] 中的部分功能。
- `点位关联`：详见 [`TDD-4` 点位关联][tdd-4]。

[bilibili]: https://bilibili.com/
[tdd-2-hidden_flag]: #hidden-flag
[tdd-3]: ./3-special-markers.md
[tdd-4]: ./4-marker-linkage.md

#### Q & A {#marker-model-qa}

- 为什么点位的图标样式和图标ID，由点位绑定的物品控制，而不是直接由点位控制？
  - 若将点位图标的显示，改为点位自身控制，则每一个点位的图标均是独立的数据。对于本地图内大量的点位来说，会造成同一个物品图标难以统一的问题，会极大的增加维护成本。而且从业务上而言，同一个物品使用同样的图标即可，无需过度精细化。
- 为什么点位需要将刷新时间和物品计数从物品的默认刷新时间复制过来，而不是直接使用物品的默认刷新时间和默认物品计数？
  - 首先，一个点位可同时存在于多个物品中。若物品默认刷新时间或物品计数不同，点位难以确定应该使用哪个物品的默认刷新时间或物品计数。
  - 其次，点位刷新时间或物品计数有可能会与物品的默认刷新时间或物品计数不同，所以需要保留对部分点位的单独修改的能力。
- 对于同时属于多个物品的点位，如何确定该点位应该依据哪个物品的配置显示图标？
  - 不同的地图实现方案有不同的能力边界，此处不限制具体的 **物品查询方案**，由地图实现人员自行决定按照哪一个物品的图标配置进行显示。但是请注意，此处只是不限制渲染图标的物品判定，但需要严格按照物品中的图标配置进行处理。

#### 其他说明 {#marker-model-misc}

- 在某些语言中，逗号被当做小数点使用。因此，在解析点位坐标 `X,Y` 时，需注意处理。

## 权限标记 {#hidden-flag}

- 权限标记存在于地区、物品和点位层级，由 `hiddenFlag` 控制，用于限制数据的可见性。
- 权限标记存在以下几种值：
  - `显示`：常规可见性，对所有地图用户可见。
  - `隐藏`：因某些特殊原因需要隐藏的数据，对所有地图用户不可见。
  - `测试服`：测试服务器数据，对所有地图用户不可见。
  - `彩蛋`：通常为限时活动数据，默认不显示，但可使用特殊方法开启或关闭其数据显示。
- 权限标记，从地区→物品→点位，存在继承和覆盖关系：
  - 继承关系：低层级的数据可继承高层级的可见性权限，即：
    - 物品继承地区的可见性权限。
    - 点位继承物品的可见性权限。
  - 覆盖关系：低层级数据自身的可见性权限，可按照以下规则覆盖高层级权限：
    - 所有可见性均可覆盖同可见性。
    - 隐藏可覆盖显示、测试服。
    - 测试服可覆盖显示、隐藏、测试服、彩蛋。
    - 彩蛋可覆盖显示。

### Q & A {#hidden-flag-qa}

- 为什么要对这三层数据都添加可见性权限？
  - 地图中数据数量分布是：地区数据最少，点位数据最多。设计地区、物品的可见性权限，是为了方便权限继承，从而减少点位可见性控制的数据维护难度。又由于在继承条件下，部分数据需要存在不同于高层级的可见性，因此物品、点位的可见性权限设计可提供继承场景下的可见性权限覆盖功能。
